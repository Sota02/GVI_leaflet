<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin="" />
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
    }

    body {
      padding: 0;
      margin: 0;
    }

    #map_canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body onload="initialize()">
  <div id="map_canvas"></div>
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin=""></script>
  //load js in local
  <script src="./FirmenDaten.js" ></script>
  <script>
    const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
    const geocodeParams = '&format=json&limit=1';
    var map = null;

    function geocode(address) {
      let encoded = encodeURI([geocodeUrl,address, geocodeParams].join(''));
      let xhr = new XMLHttpRequest();
      
      const p = new Promise((resolve, reject) => {
        xhr.open("GET", encoded, true); //true = async, false=sync
        xhr.responseType = 'json';
        xhr.send();
        xhr.onload = function () {
          if (xhr.response.length == 0) {
            //No alert is shown, because it stops map loading in browser. The Data without Adress is just ignored.
            //alert("No place found");
            return;
          }
          response = xhr.response[0];
          resolve(response);
        }
        xhr.onerror = function () {
          console.error(xhr.statusText);
        };
      });
      
      return p;
    }  
    
    function putMarker(lat,lon,varIcon){
      var marker = L.marker([lat, lon],
        { icon: varIcon }
      ).addTo(map);
    }

    function putMarker2(lat,lon,stelle){
      var varIcon;
      if(stelle == 'BPS') varIcon = redIcon;
      else varIcon = greenIcon;
       
      var marker = L.marker([lat, lon],
        { icon: varIcon }
      ).addTo(map);
    }

    var latArray = [];
    var lonArray = [];
    function putAllMarkers(jsonObj) {
      var addr = jsonObj['members'];
      var stelleArray = [];
      
      for (var i = 0; i < addr.length; i++) {
        stelleArray[i]= addr[i]['Stelle'];
        geocode(addr[i]['ConvertedAdress']).then((response) => 
          putMarker(response.lat, response.lon,redIcon));
      } 

    }

    function registerLatLon(response){
      latArray.push(response.lat);
      lonArray.push(response.lon);
    }

    var redIcon = L.icon({
        iconUrl: './images/pin1.png',
        iconSize: [40, 40], // size of the icon
        iconAnchor: [20, 20], // point of the icon which will correspond to marker's location
    });

    var greenIcon = L.icon({
        iconUrl: './images/pin2.png',
        iconSize: [40, 40], // size of the icon
        iconAnchor: [20, 20], // point of the icon which will correspond to marker's location
    });

    function initialize() {
      //set map view in browser window. Coordinate is Stuttgart
      map = L.map('map_canvas').setView([48.81, 9.16], 10);
      var osm = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        minZoom: 2,
        maxZoom: 18
      });
      map.addLayer(osm);

      // geocode('Stuttgart').then((response) => 
      //   putMarker(response.lat,response.lon));

      // console.log(myJson['members'][0]['ConvertedAdress']);
      putAllMarkers(myJson);
    }
  </script>
</body>

</html>